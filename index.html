<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Dragon Tour DEBUG</title>
<style>
body{background:#111;color:#eee;font-family:system-ui;padding:20px}
pre{background:#000;padding:12px;border-radius:8px;overflow:auto}
.ok{color:#7CFC98}
.bad{color:#ff6b6b}
</style>
</head>
<body>

<h1>Dragon Tour – Debug Mode</h1>
<div id="status">Starting…</div>

<h3>MonthlyScores CSV (first 500 chars)</h3>
<pre id="csvA"></pre>

<h3>SeasonPoints CSV (first 500 chars)</h3>
<pre id="csvB"></pre>

<h3>Parsed Headers</h3>
<pre id="headers"></pre>

<h3>Parsed Rows (count)</h3>
<pre id="rows"></pre>

<script>
const SHEET_ID = "1-Wo8A1lNGSMO6z85mLvxemk2CxP_tPihK9mEzTeesOA";
const TAB_MONTHLY = "MonthlyScores";
const TAB_SEASON = "SeasonPoints";

const status = document.getElementById("status");
const csvAEl = document.getElementById("csvA");
const csvBEl = document.getElementById("csvB");
const headersEl = document.getElementById("headers");
const rowsEl = document.getElementById("rows");

function parseCSV(text){
  const rows=[];
  let row=[],cur="",q=false;
  text=String(text).replace(/\uFEFF/g,"").replace(/\r/g,"");
  for(let i=0;i<text.length;i++){
    const c=text[i],n=text[i+1];
    if(c=='"'){
      if(q && n=='"'){cur+='"';i++} else q=!q;
    } else if(c==','&&!q){
      row.push(cur);cur="";
    } else if(c=='\n'&&!q){
      row.push(cur);rows.push(row);row=[];cur="";
    } else cur+=c;
  }
  row.push(cur);rows.push(row);
  return {
    headers: rows[0].map(h=>h.trim().toLowerCase()),
    rows: rows.slice(1)
  };
}

async function run(){
  try{
    status.textContent="Fetching CSV…";

    const urlA=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${TAB_MONTHLY}`;
    const urlB=`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${TAB_SEASON}`;

    const [a,b]=await Promise.all([
      fetch(urlA).then(r=>r.text()),
      fetch(urlB).then(r=>r.text())
    ]);

    csvAEl.textContent=a.slice(0,500);
    csvBEl.textContent=b.slice(0,500);

    const A=parseCSV(a);
    const B=parseCSV(b);

    headersEl.textContent=JSON.stringify({
      MonthlyHeaders:A.headers,
      SeasonHeaders:B.headers
    },null,2);

    rowsEl.textContent=JSON.stringify({
      MonthlyRowCount:A.rows.length,
      SeasonRowCount:B.rows.length,
      FirstMonthlyRow:A.rows[0]
    },null,2);

    status.innerHTML="<span class='ok'>CSV parsed successfully</span>";
  }catch(e){
    status.innerHTML="<span class='bad'>ERROR: "+e+"</span>";
  }
}

run();
</script>
</body>
</html>