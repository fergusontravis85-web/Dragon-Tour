<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dragon Tour Leaderboard</title>

<style>
:root{
  --green:#0b3d2e;
  --cream:#f3efe3;
  --line:rgba(255,255,255,.16);
  --text:rgba(255,255,255,.92);
  --muted:rgba(255,255,255,.70);
  --gold:#d7c58a;
  --card:rgba(10,47,36,.82);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  color:var(--text);
  min-height:100vh;
  background:#000;
  overflow-x:hidden;
}
.bg{
  position:fixed; inset:0;
  background:
    linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.78)),
    url("https://tpc.com/wp-content/uploads/2020/04/Sawgrass1_1920x1200.jpg");
  background-size:cover;
  background-position:center;
}
.wrap{max-width:920px;margin:0 auto;padding:28px 16px 50px;}

.header{
  display:flex;justify-content:space-between;gap:16px;
  padding:18px;
  background:linear-gradient(180deg, rgba(11,61,46,.92), rgba(10,47,36,.86));
  border-radius:14px;
}
.title h1{
  margin:0;font-weight:750;letter-spacing:.08em;text-transform:uppercase;
  font-size:16px;color:var(--cream);
}
.title .sub{font-size:12px;color:var(--muted);}
.meta{font-size:12px;color:var(--muted);text-align:right;}
.meta strong{color:var(--gold);}

.card{
  margin-top:14px;background:var(--card);
  border-radius:14px;overflow:hidden;
}

.controls{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 16px;border-bottom:1px solid var(--line);
}
.segment{
  display:inline-flex;border-radius:999px;overflow:hidden;
}
.segment button{
  border:0;background:transparent;color:var(--muted);
  padding:8px 12px;font-size:12px;letter-spacing:.1em;
}
.segment button.active{
  background:rgba(215,197,138,.2);
  color:var(--cream);
}

.table-head,.row{
  display:grid;grid-template-columns:64px 1fr 160px;
  padding:14px 16px;align-items:center;
}
.table-head{
  font-size:12px;color:var(--muted);
  border-bottom:1px solid var(--line);
}
.row{border-bottom:1px solid var(--line);}
.pos{color:var(--gold);font-weight:800;}
.team .name{font-weight:650;}
.team .subline{font-size:12px;color:var(--muted);}
.value{text-align:right;font-size:18px;font-weight:850;}

.status{
  padding:10px 16px;font-size:12px;color:var(--muted);
}
.pill{
  display:inline-flex;align-items:center;gap:8px;
  padding:6px 10px;border-radius:999px;
  border:1px solid rgba(255,255,255,.15);
}
.dot{
  width:8px;height:8px;border-radius:50%;
  background:#7CFC98;
}
.dot.sync{background:#ffd166;}
.dot.bad{background:#ff6b6b;}
</style>
</head>

<body>
<div class="bg"></div>

<div class="wrap">
  <div class="header">
    <div class="title">
      <h1>Dragon Tour Leaderboard</h1>
      <div class="sub" id="subHeader">Loading…</div>
    </div>
    <div class="meta">
      Last update: <strong id="lastUpdate">—</strong>
    </div>
  </div>

  <div class="card">
    <div class="controls">
      <div id="viewHint">View: Month</div>
      <div class="segment">
        <button id="btnMonth">Month</button>
        <button id="btnSeason">Season</button>
      </div>
    </div>

    <div class="table-head">
      <div>Pos</div><div>Team</div><div>This Month</div>
    </div>
    <div id="rows"></div>

    <div class="status">
      <span class="pill">
        <span class="dot" id="dot"></span>
        <span id="statusText">Connecting…</span>
      </span>
    </div>
  </div>
</div>

<script>
const SHEET_ID = "1-Wo8A1lNGSMO6z85mLvxemk2CxP_tPihK9mEzTeesOA";
const TAB_MONTHLY = "MonthlyScores";
const TAB_SEASON = "SeasonPoints";
const REFRESH_MS = 10000;
const MONTHS = ["January","February","March","April","May","June"];

const rowsEl = document.getElementById("rows");
const statusText = document.getElementById("statusText");
const dot = document.getElementById("dot");
const subHeader = document.getElementById("subHeader");
const btnMonth = document.getElementById("btnMonth");
const btnSeason = document.getElementById("btnSeason");

let currentView = "month";
let teams = [];
let lastGoodTeams = null;

function setStatus(mode,text){
  statusText.textContent = text;
  dot.className = "dot " + (mode||"");
}

function parseCSV(t){
  const lines = t.trim().split(/\r?\n/).map(l=>l.split(","));
  return { headers: lines[0].map(h=>h.toLowerCase()), rows: lines.slice(1) };
}

function toNumber(x){
  const n = Number(String(x).replace(/[^\d.-]/g,""));
  return Number.isFinite(n)?n:0;
}

function parseGolf(v){
  if(!v) return {value:999,display:"—"};
  if(String(v).toLowerCase()=="e"||toNumber(v)==0) return {value:0,display:"E"};
  const n=toNumber(v);
  return {value:n,display:n>0?`+${n}`:`${n}`};
}

function getMonth(){
  const i=Math.min(new Date().getMonth(),5);
  return MONTHS[i];
}

function render(){
  rowsEl.innerHTML="";
  teams.forEach((t,i)=>{
    const r=document.createElement("div");
    r.className="row";
    r.innerHTML=`
      <div class="pos">${i+1}</div>
      <div class="team">
        <div class="name">${t.team}</div>
        <div class="subline">${currentView=="month"?`Season: ${t.season}`:`This month: ${t.month.display}`}</div>
      </div>
      <div class="value">${currentView=="month"?t.month.display:t.season}</div>`;
    rowsEl.appendChild(r);
  });
}

async function load(){
  try{
    setStatus("sync","Syncing…");
    const m=getMonth().toLowerCase();

    const [a,b]=await Promise.all([
      fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${TAB_MONTHLY}`).then(r=>r.text()),
      fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${TAB_SEASON}`).then(r=>r.text())
    ]);

    const A=parseCSV(a), B=parseCSV(b);
    const mi=A.headers.indexOf(m);
    const ti=A.headers.indexOf("team");
    const sm=B.headers.indexOf("team");

    const seasonMap=new Map();
    B.rows.forEach(r=>{
      let s=0;
      for(let i=1;i<r.length;i++) s+=toNumber(r[i]);
      seasonMap.set(r[sm],s);
    });

    const out=A.rows.map(r=>({
      team:r[ti],
      month:parseGolf(r[mi]),
      season:seasonMap.get(r[ti])??"—"
    })).filter(t=>t.team);

    if(out.length){
      teams=out;
      lastGoodTeams=out;
      render();
      setStatus("", "Live");
      document.getElementById("lastUpdate").textContent=new Date().toLocaleString();
    }else if(lastGoodTeams){
      teams=lastGoodTeams;
      render();
      setStatus("sync","Syncing…");
    }
  }catch(e){
    if(lastGoodTeams){
      teams=lastGoodTeams;
      render();
      setStatus("sync","Syncing…");
    }else{
      setStatus("bad","Offline");
    }
  }
}

btnMonth.onclick=()=>{currentView="month";render();};
btnSeason.onclick=()=>{currentView="season";render();};

load();
setInterval(load,REFRESH_MS);
</script>
</body>
</html>